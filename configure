#!/bin/sh
#  Based on configure of Rblpapi
#  https://github.com/Rblp/Rblpapi/blob/master/configure

## Check that we are on Unix
which uname
if [ $? -ne 0 ]; then
    echo "You do not have 'uname' so this is unlikely to be a Unix system. Exiting."
    exit 1
fi

# Library settings
PKG_TEST_HEADER="<kiwi/Kiwi.h>"
PKG_LIBS="-lkiwi"
PKG_CPPFLAGS=""
LIB_VER="0.22.2"

# Copy libcache for local development.
if [ -f "`pwd`/kiwilibtmp/libs/libkiwi.a" ]; then
  echo "Found kiwilibtmp folder!"
  mkdir -p kiwilibs
  cp -rf kiwilibtmp/* kiwilibs/
fi

# Check for custom locations
if [ "$INCLUDE_DIR" ] || [ "$LIB_DIR" ]; then
  echo "Found INCLUDE_DIR and/or LIB_DIR!"
  PKG_CPPFLAGS="-I$INCLUDE_DIR $PKG_CPPFLAGS"
  PKG_LIBS="-L$LIB_DIR $PKG_LIBS"

elif [ -d "`pwd`/kiwilibs/libs/" ]; then
  echo "Found libkiwi on pwd installation..."
  PKG_CPPFLAGS="-I`pwd`/kiwilibs/include $PKG_CPPFLAGS"
  if [ -f "`pwd`/kiwilibs/libs/libkiwi.a" ]; then
    PKG_LIBS="-L`pwd`/kiwilibs/libs $PKG_LIBS"
  elif [ -f "`pwd`/kiwilibs/libs/libkiwi.dylib" ]; then
    echo "Found libkiwi.dylib; relying on system loader paths."
    PKG_LIBS="-L`pwd`/kiwilibs/libs $PKG_LIBS"
  else
    PKG_LIBS="-L`pwd`/kiwilibs/libs $PKG_LIBS"
  fi

else
  echo "Prior system libkiwi installation not found"
  echo "Preparing to download and build library from source..."

  which git
  if [ $? -ne 0 ]; then
    echo "------------------------------[ ELBIRD ]------------------------------"
    echo "Configuration failed because 'git' was not found."
    echo "If you want to kiwi build from source in package installation prosess,"
    echo "make sure git and cmake work in system."
    echo "-------------------------------------------------------------------------"
    exit 1
  fi

  which cmake
  if [ $? -ne 0 ]; then
    export PATH=$PATH:/Applications/CMake.app/Contents/bin
  fi

  which cmake
  if [ $? -ne 0 ]; then
    echo "------------------------------[ ELBIRD ]------------------------------"
    echo "Configuration failed because 'libkiwi' and 'cmake' were not found."
    echo "If 'libkiwi' is already installed but in a non-standard location, you"
    echo "may set INCLUDE_DIR and LIB_DIR manually via:"
    echo "R CMD INSTALL --configure-vars='INCLUDE_DIR=... LIB_DIR=...'"
    echo ""
    echo "If you want to kiwi build from source in package installation prosess,"
    echo "make sure cmake work."
    echo "-------------------------------------------------------------------------"
    exit 1
  fi

  git config --global advice.detachedHead false
  PKG_ROOT="$(pwd)"
  KIWI_BUILD_DIR="$(mktemp -d)"
  cleanup_kiwi_dir() {
    if [ -n "$KIWI_BUILD_DIR" ] && [ -d "$KIWI_BUILD_DIR" ]; then
      rm -rf "$KIWI_BUILD_DIR"
    fi
  }
  trap cleanup_kiwi_dir EXIT

  git clone -b v$LIB_VER --depth 1 https://github.com/bab2min/Kiwi "$KIWI_BUILD_DIR/Kiwi"
  KIWI_SRC="$KIWI_BUILD_DIR/Kiwi"

  git -C "$KIWI_SRC" config -f .gitmodules --remove-section submodule."third_party/googletest" 2>/dev/null || true
  git -C "$KIWI_SRC" config -f .gitmodules --remove-section submodule."third_party/cpuinfo" 2>/dev/null || true
  rm -rf "$KIWI_SRC/third_party/googletest" "$KIWI_SRC/third_party/cpuinfo"
  git -C "$KIWI_SRC" submodule sync --recursive
  REQUIRED_SUBMODULES="third_party/tclap third_party/mimalloc third_party/cpp-btree third_party/eigen third_party/json third_party/streamvbyte"
  git -C "$KIWI_SRC" submodule update --init --recursive --depth 1 -- $REQUIRED_SUBMODULES

  mkdir "$KIWI_SRC/build"
  cd "$KIWI_SRC/build"
  cmake -DCMAKE_BUILD_TYPE=Release -DKIWI_BUILD_TEST=OFF -DKIWI_USE_CPUINFO=OFF -DCMAKE_POSITION_INDEPENDENT_CODE=ON -DCMAKE_CXX_STANDARD=17 -Wno-dev --log-level=ERROR -DCMAKE_POLICY_VERSION_MINIMUM=3.10 ..
  echo "** make is running..."
  make kiwi_static 1> makelog.txt 2>&1
  if [ $? -ne 0 ]; then
    make kiwi 1>> makelog.txt 2>&1
  fi
  echo "** done!"
  cd "$PKG_ROOT"

  mkdir -p kiwilibs/libs

  LIB_SRC=""
  for candidate in \
    "$KIWI_SRC/build/libkiwi_static.a" \
    "$KIWI_SRC/build/libkiwi.a" \
    "$KIWI_SRC/build/kiwi_static/libkiwi.a" \
    "$KIWI_SRC/build/kiwi_static/libkiwi_static.a"; do
    if [ -f "$candidate" ]; then
      LIB_SRC="$candidate"
      break
    fi
  done

  if [ -z "$LIB_SRC" ]; then
    LIB_SRC=$(find "$KIWI_SRC/build" -maxdepth 4 -type f \( -name "libkiwi*.a" \) | head -n 1)
  fi

  if [ -z "$LIB_SRC" ]; then
    echo "------------------------------[ ELBIRD ]------------------------------"
    echo "Configuration failed because libkiwi static library was not found."
    echo "Build directory: $KIWI_SRC/build"
    echo "-------------------------------------------------------------------------"
    exit 1
  fi

  cp -f "$LIB_SRC" kiwilibs/libs/libkiwi.a
  rm -rf kiwilibs/include
  mv -f "$KIWI_SRC/include" kiwilibs/include

  # Copy libcache for local development.
  cp -rf kiwilibs/ kiwilibtmp/
  PKG_CPPFLAGS="-I`pwd`/kiwilibs/include $PKG_CPPFLAGS"
  PKG_LIBS="-L`pwd`/kiwilibs/libs $PKG_LIBS"
fi

# For debugging
echo "Using PKG_CPPFLAGS=$PKG_CPPFLAGS"
echo "Using PKG_LIBS=$PKG_LIBS"

# Find compiler and check C++17 support first
CXX17=`${R_HOME}/bin/R CMD config CXX17`
CXX17FLAGS=`${R_HOME}/bin/R CMD config CXX17FLAGS`
CXX11=`${R_HOME}/bin/R CMD config CXX11`
CXXFLAGS=`${R_HOME}/bin/R CMD config CXXFLAGS`

# Check for C++17 support
if [ -z "$CXX17" ]; then
    echo "------------------------------[ ELBIRD ]------------------------------"
    echo "Configuration failed because C++17 support is required for Kiwi v0.22.2."
    echo "Please upgrade your compiler or R installation to support C++17."
    echo "Current R version: `${R_HOME}/bin/R --version | head -1`"
    echo "-------------------------------------------------------------------------"
    exit 1
fi

# Test C++17 compilation
echo "int main() { return 0; }" > /tmp/test_cpp17.cpp
${CXX17} ${CXX17FLAGS} -std=c++17 /tmp/test_cpp17.cpp -o /tmp/test_cpp17_out >/dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "------------------------------[ ELBIRD ]------------------------------"
    echo "Configuration failed because C++17 compilation test failed."
    echo "Please ensure your compiler supports C++17 standard."
    echo "Compiler: $CXX17"
    echo "Flags: $CXX17FLAGS"
    echo "-------------------------------------------------------------------------"
    rm -f /tmp/test_cpp17.cpp /tmp/test_cpp17_out
    exit 1
fi
rm -f /tmp/test_cpp17.cpp /tmp/test_cpp17_out

echo "C++17 support confirmed."

# Test for libkiwi using C++17
echo "#include $PKG_TEST_HEADER" | ${CXX17} ${PKG_CPPFLAGS} ${CXX17FLAGS} -std=c++17 -E -xc++ - >/dev/null 2>&1

if [ $? -ne 0 ]; then
    echo "------------------------------[ ELBIRD ]------------------------------"
    echo "Configuration failed because 'libkiwi' was not found."
    echo "If 'libkiwi' is already installed but in a non-standard location, you"
    echo "may set INCLUDE_DIR and LIB_DIR manually via:"
    echo "R CMD INSTALL --configure-vars='INCLUDE_DIR=... LIB_DIR=...'"
    echo "-------------------------------------------------------------------------"
    exit 1
fi

# Write to Makevars
sed -e "s|@cppflags@|$PKG_CPPFLAGS|" -e "s|@libs@|$PKG_LIBS|" -e "s|@cxx17flags@|$CXX17FLAGS|" src/Makevars.in > src/Makevars

# Success
exit 0
