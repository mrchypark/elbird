#!/bin/sh
#  Based on configure of Rblpapi
#  https://github.com/Rblp/Rblpapi/blob/master/configure

## Check that we are on Unix
which uname
if [ $? -ne 0 ]; then
    echo "You do not have 'uname' so this is unlikely to be a Unix system. Exiting."
    exit 1
fi

# Library settings
PKG_TEST_HEADER="<kiwi/Kiwi.h>"
PKG_LIBS="-lkiwi"
PKG_CPPFLAGS=""
LIB_VER="0.22.2"

# Copy libcache for local development.
if [ -f "`pwd`/kiwilibtmp/libs/libkiwi.a" ]; then
  echo "Found kiwilibtmp folder!"
  mkdir -p kiwilibs
  cp -rf kiwilibtmp/* kiwilibs/
fi

# Check for custom locations
if [ "$INCLUDE_DIR" ] || [ "$LIB_DIR" ]; then
  echo "Found INCLUDE_DIR and/or LIB_DIR!"
  PKG_CPPFLAGS="-I$INCLUDE_DIR $PKG_CPPFLAGS"
  PKG_LIBS="-L$LIB_DIR $PKG_LIBS"

elif [ -d "`pwd`/kiwilibs/libs/" ]; then
  echo "Found libkiwi on pwd installation..."
  PKG_CPPFLAGS="-I`pwd`/kiwilibs/include $PKG_CPPFLAGS"
  PKG_LIBS="-L`pwd`/kiwilibs/libs $PKG_LIBS"

else
  echo "Prior system libkiwi installation not found"
  echo "Preparing to download and build library from source..."

  which git
  if [ $? -ne 0 ]; then
    echo "------------------------------[ ELBIRD ]------------------------------"
    echo "Configuration failed because 'git' was not found."
    echo "If you want to kiwi build from source in package installation prosess,"
    echo "make sure git and cmake work in system."
    echo "-------------------------------------------------------------------------"
    exit 1
  fi

  which cmake
  if [ $? -ne 0 ]; then
    export PATH=$PATH:/Applications/CMake.app/Contents/bin
  fi

  which cmake
  if [ $? -ne 0 ]; then
    echo "------------------------------[ ELBIRD ]------------------------------"
    echo "Configuration failed because 'libkiwi' and 'cmake' were not found."
    echo "If 'libkiwi' is already installed but in a non-standard location, you"
    echo "may set INCLUDE_DIR and LIB_DIR manually via:"
    echo "R CMD INSTALL --configure-vars='INCLUDE_DIR=... LIB_DIR=...'"
    echo ""
    echo "If you want to kiwi build from source in package installation prosess,"
    echo "make sure cmake work."
    echo "-------------------------------------------------------------------------"
    exit 1
  fi

  git config --global advice.detachedHead false
  PKG_ROOT="$(pwd)"
  KIWI_BUILD_DIR="$(mktemp -d)"
  cleanup_kiwi_dir() {
    if [ -n "$KIWI_BUILD_DIR" ] && [ -d "$KIWI_BUILD_DIR" ]; then
      rm -rf "$KIWI_BUILD_DIR"
    fi
  }
  trap cleanup_kiwi_dir EXIT

  git clone -b v$LIB_VER https://github.com/bab2min/Kiwi "$KIWI_BUILD_DIR/Kiwi"
  KIWI_SRC="$KIWI_BUILD_DIR/Kiwi"

  git -C "$KIWI_SRC" config -f .gitmodules --remove-section submodule."third_party/googletest" 2>/dev/null || true
  git -C "$KIWI_SRC" config -f .gitmodules --remove-section submodule."third_party/cpuinfo" 2>/dev/null || true
  rm -rf "$KIWI_SRC/third_party/googletest" "$KIWI_SRC/third_party/cpuinfo"
  git -C "$KIWI_SRC" submodule sync --recursive
  REQUIRED_SUBMODULES="third_party/tclap third_party/mimalloc third_party/cpp-btree third_party/eigen third_party/json third_party/streamvbyte"
  git -C "$KIWI_SRC" submodule update --init --recursive --depth 1 -- $REQUIRED_SUBMODULES

  mkdir "$KIWI_SRC/build"
  cd "$KIWI_SRC/build"
  cmake -DCMAKE_BUILD_TYPE=Release -DKIWI_BUILD_TEST=OFF -DKIWI_USE_CPUINFO=OFF -DCMAKE_POSITION_INDEPENDENT_CODE=ON -DCMAKE_CXX_STANDARD=17 -Wno-dev --log-level=ERROR -DCMAKE_POLICY_VERSION_MINIMUM=3.10 ..
  echo "** make is running..."
  make kiwi_static 1> makelog.txt
  echo "** done!"
  cd "$PKG_ROOT"

  mkdir -p kiwilibs/libs
  mv -f "$KIWI_SRC/build/libkiwi_static.a" kiwilibs/libs/libkiwi.a
  mv -f "$KIWI_SRC/include" kiwilibs/include

  # Copy libcache for local development.
  cp -rf kiwilibs/ kiwilibtmp/
  PKG_CPPFLAGS="-I`pwd`/kiwilibs/include $PKG_CPPFLAGS"
  PKG_LIBS="-L`pwd`/kiwilibs/libs $PKG_LIBS"
fi

# For debugging
echo "Using PKG_CPPFLAGS=$PKG_CPPFLAGS"
echo "Using PKG_LIBS=$PKG_LIBS"

# Find compiler
CXX11=`${R_HOME}/bin/R CMD config CXX11`
CXXFLAGS=`${R_HOME}/bin/R CMD config CXXFLAGS`

# Test for libkiwi
echo "#include $PKG_TEST_HEADER" | ${CXX11} ${PKG_CPPFLAGS} ${CXXFLAGS} -E -xc++ - >/dev/null 2>&1

if [ $? -ne 0 ]; then
    echo "------------------------------[ ELBIRD ]------------------------------"
    echo "Configuration failed because 'libkiwi' was not found."
    echo "If 'libkiwi' is already installed but in a non-standard location, you"
    echo "may set INCLUDE_DIR and LIB_DIR manually via:"
    echo "R CMD INSTALL --configure-vars='INCLUDE_DIR=... LIB_DIR=...'"
    echo "-------------------------------------------------------------------------"
    exit 1
fi

# Write to Makevars
sed -e "s|@cppflags@|$PKG_CPPFLAGS|" -e "s|@libs@|$PKG_LIBS|" -e "s|@cxxflags@|$CXXFLAGS|" src/Makevars.in > src/Makevars

# Success
exit 0
